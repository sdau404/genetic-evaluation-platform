<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é—ä¼ æ”¹è‰¯ä¿¡æ¯æœåŠ¡å¹³å°</title>
  <!-- å¼•å…¥Supabaseå®˜æ–¹SDKï¼ˆç”¨äºAuthå’Œæ•°æ®åº“æ“ä½œï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <style>
    /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
    }
    .loading-text {
      background: #2c3e50;
      padding: 20px 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .upload-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      z-index: 9998;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .toast-success {
      background: #27ae60;
    }
    .toast-error {
      background: #e74c3c;
    }
    body {
       font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       margin: 0;
       padding: 0;
       color: #333;
       background:
         linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.65)),
         url("asset/images/sdau.jpg");
       background-size: cover;
       background-position: center;
       background-attachment: fixed;
       background-repeat: no-repeat;
       min-height: 100vh;
    }
    header {
      background-color: #2c3e50;
      color: white;
      text-align: center;
      padding: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    nav {
      background-color: #34495e;
      padding: 10px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 100%;
      text-align: center;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: 10px;
      justify-content: flex-end;
      width: 50%;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      margin-right: 20px;
    }
    nav a {
      margin: 0;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-size: 14px;
      cursor: pointer;
      display: inline-block;
      opacity: 1;
      pointer-events: auto;
    }
    .home-btn {
      background-color: #2ecc71 !important;
    }
    .home-btn:hover {
      background-color: #27ae60 !important;
    }
    nav a:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }
    nav a.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
      background-color: #95a5a6 !important;
    }
    nav a.enabled {
      opacity: 1;
      cursor: pointer;
      pointer-events: auto;
      background-color: #3498db;
      transition: all 0.3s ease;
    }
    .nav-btn {
      margin: 0;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-size: 14px;
      color: white;
      display: inline-block;
    }
    .login-btn {
      background-color: #e67e22;
    }
    .login-btn:hover {
      background-color: #d35400;
      transform: translateY(-2px);
    }
    .logout-btn {
      background-color: #e74c3c;
    }
    .logout-btn:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
    }
    .view-results-btn {
      background-color: #27ae60;
    }
    .view-results-btn:hover {
      background-color: #219653;
      transform: translateY(-2px);
    }
    .search-box {
      display: none;
      position: absolute;
      right: 20px;
      top: 60px;
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    .search-box input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      width: 200px;
      margin-right: 10px;
    }
    .search-box button {
      padding: 8px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .search-box button:hover {
      background-color: #2980b9;
    }
    main {
      width: 80%;
      margin: 40px auto;
      padding: 40px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    main h2 {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
    }
    .publish-section {
      max-width: 600px;
      margin: 0 auto;
    }
    .publish-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .publish-form:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    .publish-form input,
    .publish-form textarea,
    .publish-form select {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    .publish-form input:focus,
    .publish-form textarea:focus,
    .publish-form select:focus {
      border-color: #3498db;
      outline: none;
    }
    .publish-form textarea {
      resize: vertical;
      min-height: 120px;
    }
    .publish-form button {
      padding: 12px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .publish-form button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }
    footer {
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
      margin-top: 40px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }
    .footer-buttons {
      margin-bottom: 10px;
    }
    .footer-buttons button {
      margin: 0 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #3498db;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-size: 14px;
    }
    .footer-buttons button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }
    footer p {
      font-size: 12px;
      margin: 5px 0 0;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
      justify-content: center;
      align-items: flex-start;
      padding: 30px 0;
      overflow-y: auto;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 550px;
      max-height: calc(100vh - 80px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow-y: auto;
    }
    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }
    .close-btn:hover {
      color: #333;
    }
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    .login-form label {
      font-weight: 600;
      color: #2c3e50;
    }
    .login-form input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .login-form button {
      padding: 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .login-form button:hover {
      background-color: #2980b9;
    }
    .login-form .form-footer {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-top: 5px;
    }
    .login-form .form-footer a {
      color: #3498db;
      text-decoration: none;
    }
    .login-form .form-footer a:hover {
      text-decoration: underline;
    }
    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-col {
      flex: 1;
    }
    .file-upload {
      border: 2px dashed #ddd;
      padding: 15px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    .file-upload:hover {
      border-color: #3498db;
    }
    .file-upload input {
      display: none;
    }
    .file-upload p {
      margin: 5px 0;
      font-size: 14px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 13px;
    }
    .data-table th,
    .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .data-table th {
      background-color: #f2f2f2;
    }
    .tab-container {
      margin-bottom: 15px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 8px 15px;
      background: none;
      border: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .tab-btn.active {
      border-bottom: 3px solid #3498db;
      color: #3498db;
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .user-info {
      color: white;
      font-size: 14px;
      margin-right: 15px;
    }
    @media (max-width: 1200px) {
      nav {
        flex-wrap: wrap;
        padding: 10px 20px;
      }
      .nav-left, .nav-right {
        margin: 5px 0;
      }
      .nav-right {
        margin-left: auto;
        margin-right: 0;
      }
    }
    @media (max-width: 768px) {
      main {
        width: 90%;
        padding: 20px;
      }
      .modal-content {
        width: 90%;
        max-height: calc(100vh - 60px);
      }
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
      nav {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .nav-left, .nav-right {
        flex-direction: column;
        width: 100%;
        align-items: center;
      }
      nav a,
      .nav-btn {
        width: 80%;
        margin: 3px 0;
        text-align: center;
      }
      .user-info {
        display: none;
      }
      .search-box {
        left: 50%;
        transform: translateX(-50%);
        right: auto;
      }
    }
    /* ä¿ç•™ä½ åŸæœ‰æ‰€æœ‰æ ·å¼ï¼Œä»…ä¿®æ”¹/æ–°å¢ä»¥ä¸‹å›¾ç‰‡ç›¸å…³æ ·å¼ */
    .img-text-cards {
      display: flex;
      gap: 25px; /* å¡ç‰‡ä¹‹é—´çš„é—´è·ï¼ˆæ°´å¹³+å‚ç›´ï¼‰ */
      flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
      margin: 30px 0;
      justify-content: flex-start; /* é å·¦å¯¹é½ï¼Œä¿è¯åˆ—æ•°è§„æ•´ */
    }

    .img-text-card {
      width: calc(33.333% - (25px * 2 / 3));
      min-width: unset;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }

    .img-text-card:hover {
      transform: translateY(-5px);
    }

 /* ä¿ç•™åŸæœ‰å…¶ä»–æ ·å¼ï¼Œä»…æ›¿æ¢ä»¥ä¸‹å¡ç‰‡/å›¾ç‰‡ç›¸å…³æ ·å¼ */
.img-text-cards {
  display: flex;
  gap: 20px; /* å¾®è°ƒé—´è·ï¼Œè®©ä¸‰åˆ—å¸ƒå±€æ›´ç´§å‡‘é€‚é…å®Œæ•´å›¾ç‰‡ */
  flex-wrap: wrap;
  margin: 30px 0;
  justify-content: center; /* æ”¹ä¸ºå±…ä¸­å¯¹é½ï¼Œè§†è§‰æ›´è§„æ•´ */
}

.img-text-card {
  width: calc(30% - 15px); /* è°ƒæ•´å®½åº¦ï¼ˆä»33.333%æ”¹ä¸º30%ï¼‰ï¼Œç»™å®Œæ•´å›¾ç‰‡ç•™å‡ºç©ºé—´ */
  min-width: 180px; /* ä¿è¯å°å±å¹•ä¸‹å¡ç‰‡ä¸æŒ¤åœ¨ä¸€èµ· */
  background-color: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: transform 0.3s;
}

/* æ–°å¢ï¼šç»™å›¾ç‰‡å®¹å™¨è®¾ç½®å›ºå®šæ¯”ä¾‹ï¼ˆé€‚åˆå¤´åƒç±»å›¾ç‰‡ï¼Œæ¯”å¦‚æ­£æ–¹å½¢ï¼‰ */
.card-img {
  aspect-ratio: 1 / 1; /* å¼ºåˆ¶å›¾ç‰‡å®¹å™¨ä¸ºæ­£æ–¹å½¢ï¼Œé€‚é…å¤´åƒæ¯”ä¾‹ */
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f5; /* å›¾ç‰‡å‘¨å›´ç©ºç™½åŒºåŸŸè®¾ä¸ºæµ…ç°è‰²ï¼Œæ›´ç¾è§‚ */
}

/* æ ¸å¿ƒï¼šå›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¸è£å‰ª */
.card-img img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* æ›¿æ¢coverä¸ºcontainï¼šå›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¸è£å‰ª */
  object-position: center;
}

.card-text {
  padding: 15px; /* å¾®è°ƒå†…è¾¹è·ï¼Œè®©å¡ç‰‡æ›´ç´§å‡‘ */
  text-align: center; /* æ–‡å­—å±…ä¸­ï¼Œå’Œå¤´åƒæ­é…æ›´åè°ƒ */
}

.card-text h4 {
  color: #2c3e50;
  font-size: 16px; /* å¾®è°ƒå­—ä½“å¤§å°ï¼Œé€‚é…ç´§å‡‘å¡ç‰‡ */
  margin-bottom: 5px;
}

.card-text p {
  color: #666;
  font-size: 12px;
  line-height: 1.5;
  margin-bottom: 8px;
}

/* å“åº”å¼é€‚é…ä¿æŒä¸‰åˆ—/ä¸¤åˆ—/ä¸€åˆ—ï¼ŒåŒæ­¥è°ƒæ•´å›¾ç‰‡å®¹å™¨æ¯”ä¾‹ */
@media (max-width: 768px) {
  .img-text-card {
    width: 80%; /* ç§»åŠ¨ç«¯å•è¡Œ1åˆ—ï¼Œå®½åº¦æ›´èˆ’é€‚ */
  }
  .card-img {
    aspect-ratio: 4 / 3; /* ç§»åŠ¨ç«¯å›¾ç‰‡æ¯”ä¾‹ç¨å®½ */
  }
}

@media (min-width: 769px) and (max-width: 1200px) {
  .img-text-card {
    width: calc(45% - 10px); /* å¹³æ¿ç«¯2åˆ—å¸ƒå±€ */
  }

    /* å¯é€‰ï¼šå±å¹•åœ¨768-1200pxä¹‹é—´æ—¶æ”¹ä¸º2åˆ— */
    @media (min-width: 769px) and (max-width: 1200px) {
      .img-text-card {
        width: calc(50% - 12.5px);
      }
      /* å¹³æ¿ç«¯å›¾ç‰‡å°ºå¯¸æŠ˜ä¸­ */
      .card-img img {
        height: 110px;
        max-height: 110px;
      }
    }
    /* ===== æ–°å¢ï¼šå¤šæ–‡ä»¶é¢„è§ˆæ ·å¼ ===== */
    .file-preview {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      background-color: #f8f9fa;
      display: none;
      flex-direction: column; /* å¤šæ–‡ä»¶å‚ç›´æ’åˆ— */
      gap: 8px;
      border: 1px solid #e9ecef;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 4px;
      background-color: #fff;
      border: 1px solid #eee;
    }
    .file-icon {
      font-size: 20px;
    }
    /* ä¸åŒæ–‡ä»¶ç±»å‹çš„å›¾æ ‡é¢œè‰² */
    .icon-csv, .icon-txt, .icon-matrix {
      color: #3498db; /* è“è‰² - æ–‡æœ¬ç±»æ–‡ä»¶ */
    }
    .icon-xlsx {
      color: #27ae60; /* ç»¿è‰² - Excelæ–‡ä»¶ */
    }
    .icon-vcf, .icon-ped, .icon-map, .icon-bed, .icon-bim, .icon-fam {
      color: #9b59b6; /* ç´«è‰² - åŸºå› å‹æ–‡ä»¶ */
    }
    .file-info {
      flex: 1;
    }
    .file-name {
      font-weight: 500;
      color: #2c3e50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-size {
      font-size: 12px;
      color: #6c757d;
    }
    .file-remove {
      padding: 3px 8px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s ease;
    }
    .file-remove:hover {
      background-color: #c0392b;
    }
    /* æ‹–æ‹½é«˜äº®æ ·å¼ */
    .file-upload.drag-over {
      border-color: #3498db;
      background-color: #f0f8ff;
    }
    /* æ–°å¢æ¸…ç©ºæŒ‰é’®æ ·å¼ */
    .clear-files-btn {
      margin-top: 8px;
      padding: 5px 10px;
      background-color: #95a5a6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .clear-files-btn:hover {
      background-color: #7f8c8d;
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-text">
      <span>åŠ è½½ä¸­...</span>
    </div>
  </div>
  <div class="upload-toast" id="uploadToast"></div>

  <header>
    <h1>é—ä¼ æ”¹è‰¯ä¿¡æ¯æœåŠ¡å¹³å°</h1>
  </header>

  <nav>
    <div class="nav-left">
      <a href="index.html" class="home-btn" title="è¿”å›é¦–é¡µ">é¦–é¡µ</a>
      <a id="navPhenotype" onclick="checkLoginBeforeOpen('phenotypeModal')">è¡¨å‹æ•°æ®ä¸Šä¼ </a>
      <a id="navGenotype" onclick="checkLoginBeforeOpen('genotypeModal')">åŸºå› å‹æ•°æ®ä¸Šä¼ </a>
      <a id="navKinship" onclick="checkLoginBeforeOpen('kinshipMatrixModal')">ç³»è°±ä¸Šä¼ </a>
      <a href="ä»‹ç».html">ä»‹ç»</a>
    </div>

    <div class="nav-right">
      <div class="user-info" id="userInfo" style="display: none;">
        æ¬¢è¿ï¼Œ<span id="usernameDisplay"></span>
      </div>
      <button class="nav-btn login-btn" id="loginBtn" onclick="openModal('loginModal')">ç™»å½•</button>
      <button class="nav-btn logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">é€€å‡ºç™»å½•</button>
      <button class="nav-btn view-results-btn" id="viewResultsBtn" onclick="toggleSearchBox()" style="display: none;">é—ä¼ è¯„ä¼°ç»“æœæŸ¥çœ‹</button>
    </div>

    <div class="search-box" id="searchBox">
      <input type="text" placeholder="è¾“å…¥å…³é”®è¯æœç´¢">
      <button onclick="searchResults()">æœç´¢</button>
    </div>
  </nav>

   <main>
    <h2>ä»‹ç»</h2>
    <!-- å¤šå¡ç‰‡å›¾æ–‡å±•ç¤ºåŒº -->
    <div class="img-text-cards">
      <!-- å¡ç‰‡1 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/zhangqin.jpg" alt="å¼ å‹¤">
        </div>
        <div class="card-text">
          <h4>å¼ å‹¤</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249751/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>

      <!-- å¡ç‰‡2 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/zeng.png" alt="jieshao">
        </div>
        <div class="card-text">
          <h4>æ›¾å‹‡åº†</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249757/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>

      <!-- å¡ç‰‡3 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/fan.png" alt="jieshao">
        </div>
        <div class="card-text">
          <h4>æ¨Šæ–°å¿ </h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249761/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡4 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/tang.jpg" alt="xxx">
        </div>
        <div class="card-text">
          <h4>å”è¾‰</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249772/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡5 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/shi.png" alt="xxx">
        </div>
        <div class="card-text">
          <h4>å¸ˆç§‘è£</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249770/page.htm" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡6 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/chao.jpg" alt="xxx">
        </div>
        <div class="card-text">
          <h4>å®è¶…</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c1553a154966/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡7 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/wangdan.png" alt="xxx">
        </div>
        <div class="card-text">
          <h4>ç‹ä¸¹</h4>
          <p>æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2022/1110/c14944a249753/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡8 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/chen.jpg" alt="xxx">
        </div>
        <div class="card-text">
          <h4>é™ˆä¼Ÿ</h4>
          <p>å‰¯æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249760/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
      <!-- å¡ç‰‡9 -->
      <div class="img-text-card">
        <div class="card-img">
          <img src="asset/images/wenwen.jpg" alt="xxx">
        </div>
        <div class="card-text">
          <h4>ç‹æ–‡æ–‡</h4>
          <p>å‰¯æ•™æˆ</p>
          <a href="https://dkdy.sdau.edu.cn/2019/0904/c14944a249748/page.psp" target="_blank" rel="noopener noreferrer">é“¾æ¥</a>
        </div>
      </div>
    </div>

    </div>
  </main>

  <footer>
    <div class="footer-buttons">
      <button>Update</button>
      <button>Citation</button>
      <button>Manual</button>
    </div>
    <p>å¦‚æœå‘ç°bugï¼Œè¯·è”ç³»æˆ‘ä»¬ã€‚é‚®ç®±ä¸ºningchao@sdau.edu.cn</p>
  </footer>

  <!-- ç™»å½•æ¨¡æ€æ¡† -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
      <h2 style="text-align: center;">ç”¨æˆ·ç™»å½•</h2>
      <form class="login-form" id="loginForm">
        <label for="username">é‚®ç®±</label>
        <input type="email" id="username" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±" required>

        <label for="password">å¯†ç </label>
        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>

        <button type="submit">ç™»å½•</button>
        <div class="form-footer">
          <a href="#" onclick="switchModal('registerModal')">æ³¨å†Œè´¦å·</a>
        </div>
      </form>
    </div>
  </div>

  <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('registerModal')">&times;</span>
      <h2 style="text-align: center;">ç”¨æˆ·æ³¨å†Œ</h2>
      <form class="login-form" id="registerForm">
        <label for="regUsername">ç”¨æˆ·å</label>
        <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä½ï¼‰" required>

        <label for="regEmail">é‚®ç®±</label>
        <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥ç”¨äºæ³¨å†Œçš„é‚®ç®±" required>

        <label for="regPassword">å¯†ç </label>
        <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>

        <label for="regConfirmPassword">ç¡®è®¤å¯†ç </label>
        <input type="password" id="regConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>

        <button type="submit">æ³¨å†Œ</button>
        <div class="form-footer">
          <a href="#" onclick="switchModal('loginModal')">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</a>
        </div>
      </form>
    </div>
  </div>

  <!-- è¡¨å‹æ•°æ®å¤„ç†æ¨¡æ€æ¡†ï¼ˆæ–°å¢multipleå±æ€§+æ¸…ç©ºæŒ‰é’®ï¼‰ -->
  <div class="modal" id="phenotypeModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('phenotypeModal'); clearAllFiles('phenotype')">&times;</span>
      <h2>è¡¨å‹æ•°æ®å¤„ç†</h2>
      <div class="publish-form" id="phenotypeForm">
        <div class="form-group">
          <label for="phenotype-file">ä¸Šä¼ è¡¨å‹æ•°æ®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</label>
          <div class="file-upload" onclick="document.getElementById('phenotype-file').click()">
            <input type="file" id="phenotype-file" accept=".csv, .xlsx, .txt" multiple>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼ˆå¯å¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</p>
            <p>æ”¯æŒæ ¼å¼: CSV, Excel, TXT</p>
            <div class="file-preview" id="phenotype-file-preview"></div><!--é¢„è§ˆæ¡†-->
          </div>
          <button class="clear-files-btn" onclick="clearAllFiles('phenotype')">æ¸…ç©ºå·²é€‰æ–‡ä»¶</button>
        </div>
        <div class="form-group">
          <label for="phenotype-name">æ•°æ®é›†åç§°</label>
          <input type="text" id="phenotype-name" placeholder="è¾“å…¥æ•°æ®é›†åç§°" required>
        </div>
        <button onclick="uploadData('phenotype')">ä¸Šä¼ è¡¨å‹æ•°æ®</button>
      </div>
    </div>
  </div>

  <!-- åŸºå› å‹æ•°æ®å¤„ç†æ¨¡æ€æ¡†ï¼ˆæ–°å¢multipleå±æ€§+æ¸…ç©ºæŒ‰é’®ï¼‰ -->
  <div class="modal" id="genotypeModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('genotypeModal'); clearAllFiles('genotype')">&times;</span>
      <h2>åŸºå› å‹æ•°æ®å¤„ç†</h2>
      <div class="publish-form" id="genotypeForm">
        <div class="form-group">
          <label for="genotype-file">ä¸Šä¼ åŸºå› å‹æ•°æ®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</label>
          <div class="file-upload" onclick="document.getElementById('genotype-file').click()">
            <input type="file" id="genotype-file" accept=".vcf, .ped, .map, .bed" multiple>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼ˆå¯å¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</p>
            <p>æ”¯æŒæ ¼å¼: VCF, PED/MAP, BED/BIM/FAM</p>
            <div class="file-preview" id="genotype-file-preview"></div><!--é¢„è§ˆæ¡†-->
          </div>
          <button class="clear-files-btn" onclick="clearAllFiles('genotype')">æ¸…ç©ºå·²é€‰æ–‡ä»¶</button>
        </div>
        <div class="form-group">
          <label for="genotype-name">æ•°æ®é›†åç§°</label>
          <input type="text" id="genotype-name" placeholder="è¾“å…¥æ•°æ®é›†åç§°" required>
        </div>
        <button onclick="uploadData('genotype')">ä¸Šä¼ åŸºå› å‹æ•°æ®</button>
      </div>
    </div>
  </div>

  <!-- äº²ç¼˜å…³ç³»çŸ©é˜µè®¡ç®—æ¨¡æ€æ¡†ï¼ˆæ–°å¢multipleå±æ€§+æ¸…ç©ºæŒ‰é’®ï¼‰ -->
  <div class="modal" id="kinshipMatrixModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('kinshipMatrixModal'); clearAllFiles('kinship')">&times;</span>
      <h2>äº²ç¼˜å…³ç³»æ•°æ®ä¸Šä¼ </h2>
      <div class="publish-form" id="kinshipForm">
        <div class="form-group">
          <label for="kinship-file">ä¸Šä¼ äº²ç¼˜å…³ç³»æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</label>
          <div class="file-upload" onclick="document.getElementById('kinship-file').click()">
            <input type="file" id="kinship-file" accept=".csv, .txt, .matrix" multiple>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼ˆå¯å¤šé€‰/å¤šæ¬¡è¿½åŠ ï¼‰</p>
            <p>æ”¯æŒæ ¼å¼: CSV, TXT, MATRIX</p>
            <div class="file-preview" id="kinship-file-preview"></div><!--é¢„è§ˆæ¡†-->
          </div>
          <button class="clear-files-btn" onclick="clearAllFiles('kinship')">æ¸…ç©ºå·²é€‰æ–‡ä»¶</button>
        </div>
        <div class="form-group">
          <label for="kinship-name">æ–‡ä»¶åç§°</label>
          <input type="text" id="kinship-name" placeholder="è¾“å…¥æ–‡ä»¶åç§°" required>
        </div>
        <button onclick="uploadData('kinship')">ä¸Šä¼ äº²ç¼˜å…³ç³»æ•°æ®</button>
      </div>
    </div>
  </div>

  <!-- é—ä¼ è¯„ä¼°æ¨¡æ€æ¡† -->
  <div class="modal" id="geneticEvaluationModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('geneticEvaluationModal')">&times;</span>
      <h2>é—ä¼ è¯„ä¼°ç»“æœæŸ¥çœ‹</h2>

      <div class="publish-form" style="margin-bottom: 20px;">
        <div class="form-row">
          <div class="form-col">
            <label for="eval-species">ç‰©ç§ç­›é€‰</label>
            <select id="eval-species" onchange="filterEvalResults()">
              <option value="all">å…¨éƒ¨</option>
              <option value="çŒª" selected>çŒª</option>
              <option value="ç‰›">ç‰›</option>
              <option value="ç¾Š">ç¾Š</option>
            </select>
          </div>
          <div class="form-col">
            <label for="eval-trait">æ€§çŠ¶ç±»å‹</label>
            <select id="eval-trait" onchange="filterEvalResults()">
              <option value="all">å…¨éƒ¨</option>
              <option value="ç”Ÿé•¿æ€§çŠ¶">ç”Ÿé•¿æ€§çŠ¶</option>
              <option value="ç¹æ®–æ€§çŠ¶">ç¹æ®–æ€§çŠ¶</option>
              <option value="è‚‰è´¨æ€§çŠ¶">è‚‰è´¨æ€§çŠ¶</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="eval-search">å…³é”®è¯æœç´¢</label>
          <input type="text" id="eval-search" placeholder="è¾“å…¥è¯„ä¼°åç§°/çŒªç§å" oninput="filterEvalResults()">
        </div>
      </div>

      <div style="max-height: 400px; overflow-y: auto;">
        <table class="data-table" id="eval-results-table">
          <thead>
            <tr>
              <th>è¯„ä¼°åç§°</th>
              <th>çŒªç§/ç‰©ç§</th>
              <th>æ€§çŠ¶ç±»å‹</th>
              <th>è¯„ä¼°æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="eval-results-body">
          </tbody>
        </table>
        <div id="eval-no-result" style="text-align: center; padding: 20px; display: none;">
          æœªæ‰¾åˆ°åŒ¹é…çš„é—ä¼ è¯„ä¼°ç»“æœï½
        </div>
      </div>

      <div id="eval-detail-modal" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9;">
        <h4 style="margin-top: 0;" id="detail-title">è¯„ä¼°è¯¦æƒ…</h4>
        <div id="detail-content">
        </div>
        <button onclick="closeEvalDetail()" style="margin-top: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­è¯¦æƒ…</button>
      </div>
    </div>
  </div>

<script>
  // 1. åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨å®˜æ–¹SDKï¼Œæ”¯æŒAuthã€Storageã€Databaseï¼‰
  const supabaseUrl = "https://cwpdenrqhipxgkcwewtv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3cGRlbnJxaGlweGdrY3dld3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDM5MzUsImV4cCI6MjA4MTUxOTkzNX0.qLvLmBeu00kCZ7rvQUd4iBQFxR4lDkRLqIRM44JZ3i4";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  // 2. å…¨å±€å˜é‡
  let currentUser = null; // å½“å‰ç™»å½•ç”¨æˆ·
  let evalResults = [];//å­˜å‚¨å½“å‰ç”¨æˆ·çš„æ‰€æœ‰é—ä¼ è¯„ä¼°ç»“æœ
  // ===== æ–°å¢ï¼šå¤šæ–‡ä»¶è¿½åŠ ç¼“å­˜æ•°ç»„ =====
  let phenotypeFilesCache = []; // è¡¨å‹æ–‡ä»¶ç¼“å­˜
  let genotypeFilesCache = [];  // åŸºå› å‹æ–‡ä»¶ç¼“å­˜
  let kinshipFilesCache = [];   // äº²ç¼˜å…³ç³»æ–‡ä»¶ç¼“å­˜

  // 3. é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  window.onload = async function() {
    try {
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆæŒä¹…åŒ–ç™»å½•çŠ¶æ€ï¼‰
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      if (error) throw error;

      if (session) {
        currentUser = session.user;
      }

      // æ›´æ–°ç™»å½•çŠ¶æ€UI
      updateLoginStatus();
      // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
      bindFileChangeEvents();

      console.log("Supabaseåˆå§‹åŒ–å®Œæˆï¼Œå½“å‰ç”¨æˆ·ï¼š", currentUser?.email || "æœªç™»å½•");
    } catch (e) {
      console.error("åˆå§‹åŒ–å¤±è´¥:", e);
      showToast("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼", false);
    }
  };

  // ===== é‡å†™ï¼šç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆæ”¯æŒè¿½åŠ ï¼‰ =====
  function bindFileChangeEvents() {
    // é˜»æ­¢æ‹–æ‹½é»˜è®¤è¡Œä¸º
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // è¡¨å‹æ–‡ä»¶ - æ”¯æŒè¿½åŠ 
    const phenotypeFile = document.getElementById('phenotype-file');
    phenotypeFile.addEventListener('change', (e) => {
      handleFileAdd('phenotype', e.target.files);
      e.target.value = ''; // æ¸…ç©ºinputå€¼ï¼Œé¿å…ç›¸åŒæ–‡ä»¶ä¸è§¦å‘change
    });

    // åŸºå› å‹æ–‡ä»¶ - æ”¯æŒè¿½åŠ 
    const genotypeFile = document.getElementById('genotype-file');
    genotypeFile.addEventListener('change', (e) => {
      handleFileAdd('genotype', e.target.files);
      e.target.value = '';
    });

    // äº²ç¼˜å…³ç³»æ–‡ä»¶ - æ”¯æŒè¿½åŠ 
    const kinshipFile = document.getElementById('kinship-file');
    kinshipFile.addEventListener('change', (e) => {
      handleFileAdd('kinship', e.target.files);
      e.target.value = '';
    });

    // æ‹–æ‹½ä¸Šä¼ æ”¯æŒï¼ˆåŒæ­¥ä¿®æ”¹ä¸ºè¿½åŠ é€»è¾‘ï¼‰
    const fileUploadAreas = document.querySelectorAll('.file-upload');
    fileUploadAreas.forEach(area => {
      // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, preventDefaults, false);
      });

      // æ‹–æ‹½é«˜äº®
      ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.add('drag-over'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.remove('drag-over'), false);
      });

      // å¤„ç†æ–‡ä»¶æ‹–æ”¾ï¼ˆè¿½åŠ é€»è¾‘ï¼‰
      area.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length === 0) return;

        // æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ç±»å‹
        const fileInput = area.querySelector('input[type="file"]');
        if (fileInput.id === 'phenotype-file') handleFileAdd('phenotype', files);
        if (fileInput.id === 'genotype-file') handleFileAdd('genotype', files);
        if (fileInput.id === 'kinship-file') handleFileAdd('kinship', files);
      }, false);
    });
  }

  // ===== æ–°å¢ï¼šå¤„ç†æ–‡ä»¶è¿½åŠ æ ¸å¿ƒå‡½æ•° =====
  function handleFileAdd(fileType, newFiles) {
    // 1. ç¡®å®šç¼“å­˜æ•°ç»„å’Œé¢„è§ˆID
    let cacheArray, previewId;
    switch(fileType) {
      case 'phenotype':
        cacheArray = phenotypeFilesCache;
        previewId = 'phenotype-file-preview';
        break;
      case 'genotype':
        cacheArray = genotypeFilesCache;
        previewId = 'genotype-file-preview';
        break;
      case 'kinship':
        cacheArray = kinshipFilesCache;
        previewId = 'kinship-file-preview';
        break;
      default: return;
    }

    // 2. æŠŠæ–°é€‰çš„æ–‡ä»¶è¿½åŠ åˆ°ç¼“å­˜ï¼ˆå»é‡ï¼šé¿å…é‡å¤é€‰åŒä¸€ä¸ªæ–‡ä»¶ï¼‰
    const newFilesArray = Array.from(newFiles);
    newFilesArray.forEach(newFile => {
      // æŒ‰æ–‡ä»¶å+å¤§å°å»é‡ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
      const isDuplicate = cacheArray.some(oldFile =>
        oldFile.name === newFile.name && oldFile.size === newFile.size
      );
      if (!isDuplicate) {
        cacheArray.push(newFile);
      }
    });

    // 3. é‡æ–°æ¸²æŸ“é¢„è§ˆï¼ˆåŸºäºç¼“å­˜æ•°ç»„ï¼‰
    renderFilePreview(cacheArray, previewId);
  }

  // ===== é‡å†™ï¼šåŸºäºç¼“å­˜æ•°ç»„æ¸²æŸ“é¢„è§ˆ =====
  function renderFilePreview(fileArray, previewId) {
    const previewContainer = document.getElementById(previewId);

    if (!fileArray || fileArray.length === 0) {
      previewContainer.style.display = 'none';
      return;
    }

    // æ„å»ºå¤šæ–‡ä»¶é¢„è§ˆHTML
    let previewHtml = '';
    fileArray.forEach((file, index) => {
      const iconClass = getFileIconClass(file.name);
      const fileSize = formatFileSize(file.size);
      previewHtml += `
        <div class="file-item" data-index="${index}">
          <div class="file-icon ${iconClass}">ğŸ“„</div>
          <div class="file-info">
            <div class="file-name" title="${file.name}">${file.name}</div>
            <div class="file-size">${fileSize}</div>
          </div>
          <button class="file-remove" onclick="removeCachedFile(this, ${index})">ç§»é™¤</button>
        </div>
      `;
    });

    previewContainer.innerHTML = previewHtml;
    previewContainer.style.display = 'flex';
  }

  // ===== æ–°å¢ï¼šç§»é™¤ç¼“å­˜ä¸­çš„å•ä¸ªæ–‡ä»¶ =====
  function removeCachedFile(btn, index) {
    // 1. æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜æ•°ç»„ï¼ˆé€šè¿‡é¢„è§ˆå®¹å™¨çš„IDï¼‰
    let cacheArray;
    const previewContainer = btn.closest('.file-preview');
    if (previewContainer.id === 'phenotype-file-preview') {
      cacheArray = phenotypeFilesCache;
    } else if (previewContainer.id === 'genotype-file-preview') {
      cacheArray = genotypeFilesCache;
    } else if (previewContainer.id === 'kinship-file-preview') {
      cacheArray = kinshipFilesCache;
    } else {
      return;
    }

    // 2. åˆ é™¤æŒ‡å®šç´¢å¼•çš„æ–‡ä»¶
    cacheArray.splice(index, 1);

    // 3. é‡æ–°æ¸²æŸ“é¢„è§ˆ
    renderFilePreview(cacheArray, previewContainer.id);
  }

  // ===== æ–°å¢ï¼šæ¸…ç©ºæŒ‡å®šç±»å‹çš„æ‰€æœ‰ç¼“å­˜æ–‡ä»¶ =====
  function clearAllFiles(fileType) {
    let cacheArray, previewId;
    switch(fileType) {
      case 'phenotype':
        cacheArray = phenotypeFilesCache;
        previewId = 'phenotype-file-preview';
        break;
      case 'genotype':
        cacheArray = genotypeFilesCache;
        previewId = 'genotype-file-preview';
        break;
      case 'kinship':
        cacheArray = kinshipFilesCache;
        previewId = 'kinship-file-preview';
        break;
      default: return;
    }
    // æ¸…ç©ºç¼“å­˜
    cacheArray.length = 0;
    // æ¸…ç©ºé¢„è§ˆ
    renderFilePreview([], previewId);
  }

  // 5. æ˜¾ç¤º/éšè—åŠ è½½æç¤º
  function showLoading(text = "ä¸Šä¼ ä¸­...") {
    const loading = document.getElementById('loadingOverlay');
    loading.querySelector('.loading-text span').textContent = text;
    loading.style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // 6. æ˜¾ç¤ºä¸Šä¼ æç¤º
  function showToast(message, isSuccess = true) {
    const toast = document.getElementById('uploadToast');
    toast.textContent = message;
    toast.className = 'upload-toast ' + (isSuccess ? 'toast-success' : 'toast-error');
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }

  // 7. æ ¸å¿ƒä¸Šä¼ å‡½æ•°ï¼ˆä¿®æ”¹ä¸ºä»ç¼“å­˜è¯»å–æ–‡ä»¶ï¼‰
  async function uploadData(dataType) {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!currentUser) {
      showToast('è¯·å…ˆç™»å½•åå†ä¸Šä¼ æ•°æ®ï¼', false);
      openModal('loginModal');
      return;
    }

    // è·å–DOMå…ƒç´ 
    let dataNameDomId = '';
    let cacheArray = []; // è¯»å–å¯¹åº”çš„ç¼“å­˜æ•°ç»„
    let typeName = '';
    switch(dataType) {
      case 'phenotype':
        dataNameDomId = 'phenotype-name';
        cacheArray = phenotypeFilesCache; // ä»ç¼“å­˜è¯»å–
        typeName = 'è¡¨å‹';
        break;
      case 'genotype':
        dataNameDomId = 'genotype-name';
        cacheArray = genotypeFilesCache;  // ä»ç¼“å­˜è¯»å–
        typeName = 'åŸºå› å‹';
        break;
      case 'kinship':
        dataNameDomId = 'kinship-name';
        cacheArray = kinshipFilesCache;   // ä»ç¼“å­˜è¯»å–
        typeName = 'äº²ç¼˜å…³ç³»';
        break;
      default:
        showToast('æœªçŸ¥çš„ä¸Šä¼ ç±»å‹ï¼', false);
        return;
    }

    // è·å–è¾“å…¥å€¼
    const dataName = document.getElementById(dataNameDomId).value.trim();

    // åŸºç¡€æ ¡éªŒ
    if (!dataName) {
      showToast(`è¯·è¾“å…¥${typeName}æ•°æ®é›†åç§°ï¼`, false);
      return;
    }
    if (!cacheArray || cacheArray.length === 0) {
      showToast(`è¯·é€‰æ‹©${typeName}ä¸Šä¼ æ–‡ä»¶ï¼`, false);
      return;
    }

    // æ ¡éªŒæ¯ä¸ªæ–‡ä»¶å¤§å°
    const maxSize = 5 * 1024 * 1024; // 5MB
    for (const file of cacheArray) {
      if (file.size > maxSize) {
        showToast(`æ–‡ä»¶ã€${file.name}ã€‘å¤§å°è¶…è¿‡5MBï¼`, false);
        return;
      }
    }

    try {
      showLoading(`æ­£åœ¨ä¸Šä¼ ${typeName}æ•°æ®ï¼ˆå…±${cacheArray.length}ä¸ªæ–‡ä»¶ï¼‰...`);

      // å¾ªç¯ä¸Šä¼ æ¯ä¸ªæ–‡ä»¶ï¼ˆä»ç¼“å­˜æ•°ç»„è¯»å–ï¼‰
      const uploadResults = [];
      for (const file of cacheArray) {
        // ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
        const safeFileName = file.name.replace(/[^a-zA-Z0-9_\-\.]/g, '_');
        const fileName = `${Date.now()}_${safeFileName}`;
        const filePath = `${dataType}/${currentUser.id}/${fileName}`;

        // æ­¥éª¤1ï¼šä¸Šä¼ æ–‡ä»¶åˆ°Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage
          .from('genetic-data')
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (uploadError) throw new Error(`æ–‡ä»¶ã€${file.name}ã€‘ä¸Šä¼ å¤±è´¥ï¼š${uploadError.message}`);

        // æ­¥éª¤2ï¼šè·å–ç­¾åURL
        const { data: signedUrlData, error: signedUrlError } = await supabaseClient
          .storage
          .from('genetic-data')
          .createSignedUrl(filePath, 60 * 60 * 24); // 24å°æ—¶æœ‰æ•ˆæœŸ

        if (signedUrlError) throw new Error(`æ–‡ä»¶ã€${file.name}ã€‘è·å–URLå¤±è´¥ï¼š${signedUrlError.message}`);

        // æ­¥éª¤3ï¼šå†™å…¥æ•°æ®åº“ï¼ˆæ¯ä¸ªæ–‡ä»¶ä¸€æ¡è®°å½•ï¼‰
        const { error: dbError } = await supabaseClient
          .from('uploaded_data') // è¯·ç¡®ä¿Supabaseä¸­å·²åˆ›å»ºæ­¤è¡¨
          .insert([
            {
              user_id: currentUser.id,          // ç”¨æˆ·ID
              data_type: dataType,              // æ•°æ®ç±»å‹
              data_name: dataName,              // æ•°æ®é›†åç§°
              file_name: file.name,             // åŸå§‹æ–‡ä»¶å
              file_path: filePath,              // å­˜å‚¨è·¯å¾„
              file_url: signedUrlData.signedUrl,// è®¿é—®URL
              file_size: file.size,             // æ–‡ä»¶å¤§å°
              upload_time: new Date().toISOString(), // ä¸Šä¼ æ—¶é—´
              file_type: dataType               //æ–‡ä»¶ç±»å‹ï¼ˆåŸºå› å‹ã€è¡¨å‹ã€ç³»è°±ï¼‰
            }
          ]);

        if (dbError) throw new Error(`æ–‡ä»¶ã€${file.name}ã€‘å†™å…¥æ•°æ®åº“å¤±è´¥ï¼š${dbError.message}`);

        uploadResults.push(file.name);
      }

      // æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
      hideLoading();
      showToast(`${typeName}æ•°æ®é›†ä¸Šä¼ æˆåŠŸï¼å…±ä¸Šä¼ ${uploadResults.length}ä¸ªæ–‡ä»¶`, true);
      alert(`âœ… ${typeName}æ•°æ®é›†ä¸Šä¼ æˆåŠŸï¼
      åç§°ï¼š${dataName}
      ç”¨æˆ·IDï¼š${currentUser.id}
      ä¸Šä¼ æ–‡ä»¶ï¼š${uploadResults.join('\n- ')}`);

      // é‡ç½®è¡¨å•ï¼ˆæ¸…ç©ºè¾“å…¥æ¡†+ç¼“å­˜+é¢„è§ˆï¼‰
      document.getElementById(dataNameDomId).value = '';
      // æ¸…ç©ºå¯¹åº”ç¼“å­˜
      if (dataType === 'phenotype') phenotypeFilesCache = [];
      if (dataType === 'genotype') genotypeFilesCache = [];
      if (dataType === 'kinship') kinshipFilesCache = [];
      // æ¸…ç©ºé¢„è§ˆ
      const previewId = dataNameDomId.replace('-name', '-file-preview');
      const previewContainer = document.getElementById(previewId);
      if (previewContainer) {
        previewContainer.style.display = 'none';
        previewContainer.innerHTML = '';
      }

      // å…³é—­æ¨¡æ€æ¡†
      closeModal(`${dataType}Modal`);

    } catch (e) {
      hideLoading();
      console.error(`${typeName}ä¸Šä¼ å¤±è´¥:`, e);
      showToast(`${typeName}ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, false);
      alert(`âŒ ${typeName}ä¸Šä¼ å¤±è´¥ï¼š${e.message}
      è¯·æ£€æŸ¥ï¼š
      1. æ‰€æœ‰æ–‡ä»¶å¤§å°æ˜¯å¦<5MB
      2. ç½‘ç»œæ˜¯å¦æ­£å¸¸
      3. æ•°æ®é›†åç§°æ˜¯å¦å¡«å†™`);
    }
  }

  // 8. æ¨¡æ€æ¡†æ“ä½œå‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
      console.error('æœªæ‰¾åˆ°æ¨¡æ€æ¡†ï¼š', modalId);
      showToast('åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥é¡µé¢ï¼', false);
      return;
    }
    modal.style.display = 'flex';
    // æ‰“å¼€æ¨¡æ€æ¡†æ—¶æ¸…ç©ºç¼“å­˜å’Œé¢„è§ˆ
    if (modalId === 'phenotypeModal') clearAllFiles('phenotype');
    if (modalId === 'genotypeModal') clearAllFiles('genotype');
    if (modalId === 'kinshipMatrixModal') clearAllFiles('kinship');
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function switchModal(targetModalId) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      }
    });
    openModal(targetModalId);
  }

  // 9. ç™»å½•çŠ¶æ€ç›¸å…³å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
  function checkLoginBeforeOpen(modalId) {
    if (!currentUser) {
      showToast('è¯·å…ˆç™»å½•åä½¿ç”¨æ­¤åŠŸèƒ½ï¼', false);
      openModal('loginModal');
      return;
    }
    openModal(modalId);
  }

  function updateLoginStatus() {
    // æ›´æ–°å¯¼èˆªæ å’ŒæŒ‰é’®çŠ¶æ€
    document.getElementById('userInfo').style.display = currentUser ? 'block' : 'none';
    document.getElementById('loginBtn').style.display = currentUser ? 'none' : 'inline-block';
    document.getElementById('logoutBtn').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('viewResultsBtn').style.display = currentUser ? 'inline-block' : 'none';

    // æ›´æ–°å¯¼èˆªé“¾æ¥çŠ¶æ€ï¼ˆæœªç™»å½•æ—¶ç¦ç”¨ä¸Šä¼ åŠŸèƒ½ï¼‰
    const navLinks = ['navPhenotype', 'navGenotype', 'navKinship'];
    navLinks.forEach(id => {
      const link = document.getElementById(id);
      if (link) {
        link.classList.toggle('disabled', !currentUser);
        link.classList.toggle('enabled', currentUser);
      }
    });

    // æ˜¾ç¤ºç”¨æˆ·å
    if (currentUser) {
      document.getElementById('usernameDisplay').textContent = currentUser.email.split('@')[0];
    }
  }

  // 10. çœŸå®çš„ç™»å½•åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
      showToast('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼', false);
      return;
    }

    try {
      showLoading("ç™»å½•ä¸­...");
      // è°ƒç”¨Supabase Authç™»å½•
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
      });

      if (error) throw error;

      // ç™»å½•æˆåŠŸï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
      currentUser = data.user;
      showToast('ç™»å½•æˆåŠŸï¼');
      updateLoginStatus();
      closeModal('loginModal');
      this.reset();

      console.log("ç”¨æˆ·ç™»å½•æˆåŠŸï¼š", currentUser.email);
    } catch (e) {
      hideLoading();
      console.error("ç™»å½•å¤±è´¥ï¼š", e);
      // å‹å¥½çš„é”™è¯¯æç¤º
      if (e.message.includes('Invalid login credentials')) {
        showToast('é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼', false);
      } else {
        showToast(`ç™»å½•å¤±è´¥ï¼š${e.message}`, false);
      }
    } finally {
      hideLoading();
    }
  });

  // 11. çœŸå®çš„æ³¨å†ŒåŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰
  document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const confirmPassword = document.getElementById('regConfirmPassword').value.trim();

    // è¡¨å•éªŒè¯
    if (!username || username.length < 3) {
      showToast('ç”¨æˆ·åè‡³å°‘3ä½ï¼', false);
      return;
    }
    if (!email) {
      showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±ï¼', false);
      return;
    }
    if (password.length < 6) {
      showToast('å¯†ç è‡³å°‘6ä½ï¼', false);
      return;
    }
    if (password !== confirmPassword) {
      showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', false);
      return;
    }

    try {
      showLoading("æ³¨å†Œä¸­...");
      // è°ƒç”¨Supabase Authæ³¨å†Œ
      const { data, error } = await supabaseClient.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            username: username // é¢å¤–çš„ç”¨æˆ·ä¿¡æ¯
          }
        }
      });

      if (error) throw error;

      // æ³¨å†ŒæˆåŠŸ
      showToast('æ³¨å†ŒæˆåŠŸï¼è¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶åç™»å½•', true);
      switchModal('loginModal');
      this.reset();

      console.log("ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼š", email);
    } catch (e) {
      hideLoading();
      console.error("æ³¨å†Œå¤±è´¥ï¼š", e);
      // å‹å¥½çš„é”™è¯¯æç¤º
      if (e.message.includes('Email already registered')) {
        showToast('è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼', false);
      } else {
        showToast(`æ³¨å†Œå¤±è´¥ï¼š${e.message}`, false);
      }
    } finally {
      hideLoading();
    }
  });

  // 12. é€€å‡ºç™»å½•åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰
  async function logout() {
    try {
      showLoading("é€€å‡ºç™»å½•ä¸­...");
      // è°ƒç”¨Supabase Authé€€å‡ºç™»å½•
      const { error } = await supabaseClient.auth.signOut();

      if (error) throw error;

      // é‡ç½®ç”¨æˆ·çŠ¶æ€
      currentUser = null;
      showToast('é€€å‡ºç™»å½•æˆåŠŸï¼');
      updateLoginStatus();

      // æ¸…ç©ºæ–‡ä»¶ç¼“å­˜
      phenotypeFilesCache = [];
      genotypeFilesCache = [];
      kinshipFilesCache = [];

      console.log("ç”¨æˆ·å·²é€€å‡ºç™»å½•");
    } catch (e) {
      hideLoading();
      console.error("é€€å‡ºç™»å½•å¤±è´¥ï¼š", e);
      showToast(`é€€å‡ºç™»å½•å¤±è´¥ï¼š${e.message}`, false);
    } finally {
      hideLoading();
    }
  }

  // 13. å…¶ä»–è¾…åŠ©å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
  function toggleSearchBox() {
    const searchBox = document.getElementById('searchBox');
    searchBox.style.display = 'none'; // éšè—æ—§çš„ç®€å•æœç´¢æ¡†
    openModal('geneticEvaluationModal'); // æ‰“å¼€é—ä¼ è¯„ä¼°ç»“æœæ¨¡æ€æ¡†
    loadEvalResults(); // åŠ è½½è¯„ä¼°ç»“æœæ•°æ®
  }

  // ========== æ–°å¢ï¼šæ¸²æŸ“è¯„ä¼°ç»“æœè¡¨æ ¼ ==========
  function renderEvalResultsTable(data) {
    const tableBody = document.getElementById('eval-results-body');
    const noResultDiv = document.getElementById('eval-no-result');

    // æ¸…ç©ºè¡¨æ ¼
    tableBody.innerHTML = '';

    // æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
    if (data.length === 0) {
      noResultDiv.style.display = 'block';
      return;
    }
    noResultDiv.style.display = 'none';

    // æ¸²æŸ“æ¯ä¸€è¡Œæ•°æ®
    data.forEach(item => {
      const tr = document.createElement('tr');

      // æ ¼å¼åŒ–æ—¶é—´ï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
      const evalTime = new Date(item.eval_time);
      const formattedTime = evalTime.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      tr.innerHTML = `
        <td>${item.eval_name || 'æœªå‘½åè¯„ä¼°'}</td>
        <td>${item.species || 'æœªçŸ¥'}</td>
        <td>${item.trait_type || 'æœªçŸ¥'}</td>
        <td>${formattedTime}</td>
        <td>
          <button onclick="viewEvalDetail('${item.id}')" style="padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</button>
          <button onclick="downloadEvalResult('${item.id}')" style="margin-left: 5px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¸‹è½½ç»“æœ</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // ========== æ–°å¢ï¼šåŠ è½½é—ä¼ è¯„ä¼°ç»“æœï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰ ==========
  async function loadEvalResults() {
    if (!currentUser) {
      showToast('è¯·å…ˆç™»å½•åæŸ¥çœ‹è¯„ä¼°ç»“æœï¼', false);
      return;
    }

    try {
      showLoading('æ­£åœ¨åŠ è½½è¯„ä¼°ç»“æœ...');

      // ä»Supabaseè·å–å½“å‰ç”¨æˆ·çš„é—ä¼ è¯„ä¼°æ•°æ®
      const { data, error } = await supabaseClient
        .from('genetic_evaluation')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('eval_time', { ascending: false }); // æŒ‰è¯„ä¼°æ—¶é—´å€’åº

      if (error) throw error;

      evalResults = data || [];
      renderEvalResultsTable(evalResults); // æ¸²æŸ“è¡¨æ ¼
      hideLoading();

    } catch (e) {
      hideLoading();
      console.error('åŠ è½½è¯„ä¼°ç»“æœå¤±è´¥ï¼š', e);
      showToast(`åŠ è½½å¤±è´¥ï¼š${e.message}`, false);
      renderEvalResultsTable([]); // æ¸…ç©ºè¡¨æ ¼
    }
  }

  // ========== æ–°å¢ï¼šæŸ¥çœ‹è¯„ä¼°è¯¦æƒ… ==========
  async function viewEvalDetail(evalId) {
    try {
      showLoading('åŠ è½½è¯¦æƒ…...');

      // ä»æ•°æ®åº“è·å–è¯¦æƒ…
      const { data, error } = await supabaseClient
        .from('genetic_evaluation')
        .select('*')
        .eq('id', evalId)
        .single();

      if (error) throw error;

      const detailModal = document.getElementById('eval-detail-modal');
      const detailTitle = document.getElementById('detail-title');
      const detailContent = document.getElementById('detail-content');

      // è®¾ç½®æ ‡é¢˜
      detailTitle.textContent = `è¯„ä¼°è¯¦æƒ…ï¼š${data.eval_name || 'æœªå‘½åè¯„ä¼°'}`;

      // æ¸²æŸ“è¯¦æƒ…å†…å®¹ï¼ˆé€‚é…JSONæ ¼å¼çš„è¯¦æƒ…æ•°æ®ï¼‰
      let detailsHtml = `
        <div style="line-height: 1.8;">
          <p><strong>ç‰©ç§ï¼š</strong>${data.species || 'æœªçŸ¥'}</p>
          <p><strong>æ€§çŠ¶ç±»å‹ï¼š</strong>${data.trait_type || 'æœªçŸ¥'}</p>
          <p><strong>è¯„ä¼°æ—¶é—´ï¼š</strong>${new Date(data.eval_time).toLocaleString('zh-CN')}</p>
          <p><strong>å…³è”æ•°æ®IDï¼š</strong>${data.data_id || 'æ— '}</p>
          <hr>
          <p><strong>è¯„ä¼°ç»“æœè¯¦æƒ…ï¼š</strong></p>
      `;

      // è§£æJSONæ ¼å¼çš„è¯„ä¼°è¯¦æƒ…
      if (typeof data.eval_details === 'object' && data.eval_details !== null) {
        detailsHtml += '<ul style="padding-left: 20px;">';
        Object.entries(data.eval_details).forEach(([key, value]) => {
          detailsHtml += `<li><strong>${key}ï¼š</strong>${JSON.stringify(value, null, 2)}</li>`;
        });
        detailsHtml += '</ul>';
      } else {
        detailsHtml += `<p>${data.eval_details || 'æ— è¯¦æƒ…æ•°æ®'}</p>`;
      }

      detailsHtml += '</div>';
      detailContent.innerHTML = detailsHtml;

      // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
      detailModal.style.display = 'block';
      hideLoading();

    } catch (e) {
      hideLoading();
      console.error('åŠ è½½è¯¦æƒ…å¤±è´¥ï¼š', e);
      showToast(`åŠ è½½è¯¦æƒ…å¤±è´¥ï¼š${e.message}`, false);
    }
  }

  // ========== æ–°å¢ï¼šä¸‹è½½è¯„ä¼°ç»“æœ ==========
  async function downloadEvalResult(evalId) {
    try {
      showLoading('å‡†å¤‡ä¸‹è½½æ–‡ä»¶...');

      // 1. è·å–è¯„ä¼°æ•°æ®
      const { data: evalData, error: evalError } = await supabaseClient
        .from('genetic_evaluation')
        .select('*')
        .eq('id', evalId)
        .single();

      if (evalError) throw evalError;

      // 2. æ„é€ ä¸‹è½½å†…å®¹ï¼ˆå¯ä»¥æ˜¯JSON/CSVæ ¼å¼ï¼‰
      const downloadContent = JSON.stringify({
        è¯„ä¼°åç§°: evalData.eval_name,
        ç‰©ç§: evalData.species,
        æ€§çŠ¶ç±»å‹: evalData.trait_type,
        è¯„ä¼°æ—¶é—´: new Date(evalData.eval_time).toLocaleString('zh-CN'),
        è¯„ä¼°è¯¦æƒ…: evalData.eval_details
      }, null, 2);

      // 3. åˆ›å»ºä¸‹è½½é“¾æ¥
      const blob = new Blob([downloadContent], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${evalData.eval_name || 'é—ä¼ è¯„ä¼°ç»“æœ'}_${new Date().getTime()}.json`;
      document.body.appendChild(a);
      a.click();

      // 4. æ¸…ç†
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      hideLoading();
      showToast('ä¸‹è½½æˆåŠŸï¼');

    } catch (e) {
      hideLoading();
      console.error('ä¸‹è½½å¤±è´¥ï¼š', e);
      showToast(`ä¸‹è½½å¤±è´¥ï¼š${e.message}`, false);
    }
  }

  function searchResults() {
    const searchInput = document.querySelector('.search-box input').value.trim();
    if (!searchInput) {
      showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼', false);
      return;
    }
    alert(`æœç´¢å…³é”®è¯ï¼š${searchInput}\nï¼ˆæ¨¡æ‹Ÿæœç´¢åŠŸèƒ½ï¼Œæš‚æ— çœŸå®æ•°æ®ï¼‰`);
  }

  function closeEvalDetail() {
    document.getElementById('eval-detail-modal').style.display = 'none';
  }

  // ========== ä¿®æ”¹ï¼šå®ç°ç­›é€‰åŠŸèƒ½ ==========
  function filterEvalResults() {
    if (evalResults.length === 0) {
      showToast('æš‚æ— æ•°æ®å¯ç­›é€‰', false);
      return;
    }

    // è·å–ç­›é€‰æ¡ä»¶
    const species = document.getElementById('eval-species').value;
    const trait = document.getElementById('eval-trait').value;
    const keyword = document.getElementById('eval-search').value.trim().toLowerCase();

    // æ‰§è¡Œç­›é€‰
    const filteredData = evalResults.filter(item => {
      // ç‰©ç§ç­›é€‰
      const matchSpecies = species === 'all' || item.species === species;
      // æ€§çŠ¶ç±»å‹ç­›é€‰
      const matchTrait = trait === 'all' || item.trait_type === trait;
      // å…³é”®è¯ç­›é€‰ï¼ˆåŒ¹é…è¯„ä¼°åç§°ã€ç‰©ç§ã€æ€§çŠ¶ç±»å‹ï¼‰
      const matchKeyword = keyword === ''
        ? true
        : (item.eval_name?.toLowerCase().includes(keyword) ||
           item.species?.toLowerCase().includes(keyword) ||
           item.trait_type?.toLowerCase().includes(keyword));
        return matchSpecies && matchTrait && matchKeyword;
    });

    // æ¸²æŸ“ç­›é€‰åçš„ç»“æœ
    renderEvalResultsTable(filteredData);
  }

  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
  document.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.style.display = 'none';
      });
    }
  });

  // ===== æ–°å¢ï¼šè¾…åŠ©å‡½æ•° - è·å–æ–‡ä»¶ç±»å‹å¯¹åº”çš„å›¾æ ‡ç±» =====
  function getFileIconClass(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    switch(ext) {
      case 'csv': return 'icon-csv';
      case 'xlsx': return 'icon-xlsx';
      case 'txt': return 'icon-txt';
      case 'matrix': return 'icon-matrix';
      case 'vcf': return 'icon-vcf';
      case 'ped': return 'icon-ped';
      case 'map': return 'icon-map';
      case 'bed': return 'icon-bed';
      case 'bim': return 'icon-bim';
      case 'fam': return 'icon-fam';
      default: return 'icon-csv'; // é»˜è®¤å›¾æ ‡
    }
  }

  // ===== æ–°å¢ï¼šè¾…åŠ©å‡½æ•° - æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚è½¬KB/MBï¼‰ =====
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  // ===== ä¿®æ”¹ï¼šæ”¯æŒå¤šæ–‡ä»¶é¢„è§ˆ =====
  function showFilePreview(fileInputId, previewId) {
    const fileInput = document.getElementById(fileInputId);
    const previewContainer = document.getElementById(previewId);
    const files = fileInput.files; // ç°åœ¨æ˜¯ FileListï¼ˆå¤šæ–‡ä»¶ï¼‰

    if (!files || files.length === 0) {
      previewContainer.style.display = 'none';
      return;
    }

    // æ„å»ºå¤šæ–‡ä»¶é¢„è§ˆHTML
    let previewHtml = '';
    Array.from(files).forEach((file, index) => {
      const iconClass = getFileIconClass(file.name);
      const fileSize = formatFileSize(file.size);
      // æ¯ä¸ªæ–‡ä»¶é¡¹åŠ ç´¢å¼•ï¼Œæ–¹ä¾¿ç§»é™¤
      previewHtml += `
        <div class="file-item" data-index="${index}">
          <div class="file-icon ${iconClass}">ğŸ“„</div>
          <div class="file-info">
            <div class="file-name" title="${file.name}">${file.name}</div>
            <div class="file-size">${fileSize}</div>
          </div>
          <button class="file-remove" onclick="removeSingleFile('${fileInputId}', '${previewId}', ${index})">ç§»é™¤</button>
        </div>
      `;
    });

    previewContainer.innerHTML = previewHtml;
    previewContainer.style.display = 'flex'; // æ˜¾ç¤ºå¤šæ–‡ä»¶åˆ—è¡¨
  }

  // ===== æ–°å¢ï¼šç§»é™¤å•ä¸ªæ–‡ä»¶ï¼ˆå¤šæ–‡ä»¶åœºæ™¯ï¼‰ =====
  function removeSingleFile(fileInputId, previewId, removeIndex) {
    const fileInput = document.getElementById(fileInputId);
    const previewContainer = document.getElementById(previewId);
    const files = fileInput.files;

    // FileList æ˜¯åªè¯»çš„ï¼Œéœ€è¦è½¬æˆæ•°ç»„å¤„ç†
    const fileArray = Array.from(files);
    // åˆ é™¤æŒ‡å®šç´¢å¼•çš„æ–‡ä»¶
    fileArray.splice(removeIndex, 1);

    // é‡æ–°æ„å»º FileListï¼ˆé€šè¿‡ DataTransferï¼‰
    const dt = new DataTransfer();
    fileArray.forEach(file => dt.items.add(file));
    fileInput.files = dt.files;

    // é‡æ–°æ¸²æŸ“é¢„è§ˆ
    showFilePreview(fileInputId, previewId);
  }

  // ===== ä¿®æ”¹ï¼šæ‰¹é‡æ¸…ç©ºæ–‡ä»¶ =====
  function removeFile(fileInputId, previewId) {
    const fileInput = document.getElementById(fileInputId);
    const previewContainer = document.getElementById(previewId);

    // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
    fileInput.value = '';
    previewContainer.style.display = 'none';
    previewContainer.innerHTML = '';
  }
</script>

</body>
</html>